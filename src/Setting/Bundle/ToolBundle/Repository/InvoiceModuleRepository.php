<?php

namespace Setting\Bundle\ToolBundle\Repository;
use Doctrine\ORM\EntityRepository;
use Setting\Bundle\ToolBundle\Entity\InvoiceModule;
use Setting\Bundle\ToolBundle\Entity\InvoiceModuleItem;
use Setting\Bundle\ToolBundle\Entity\InvoiceSmsEmail;

/**
 * InvoiceModuleRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class InvoiceModuleRepository extends EntityRepository
{

    public function domainInvoice($globalOption)
    {

        $qb = $this->createQueryBuilder('i');
        $qb->where("i.globalOption = :globalOption");
        $qb->setParameter('globalOption', $globalOption->getId());
        $qb->andWhere("i.process != :process");
        $qb->setParameter('process', 'Created');
        $qb->orderBy('i.updated','DESc');
        $query = $qb->getQuery();
        return $query;
    }

    public function insertInvoiceItem(InvoiceModule $invoice)
    {

        $item = New InvoiceModuleItem();
        $item->setInvoiceModule($invoice);
        $item->setName("Monthly service charge");
        $item->setAmount($invoice->getGlobalOption()->getMonthlyAmount());
        $this->_em->persist($item);

        // $this->insertAppModule($invoice);
        // $this->insertModule($invoice);
        // $this->insertSyndicateModule($invoice);

        $this->updateInvoice($invoice);
    }

    public function updateInvoice($invoice)
    {

        $qb = $this->_em->createQueryBuilder();
        $qb->select('SUM(i.amount)');
        $qb->from('SettingToolBundle:InvoiceModuleItem','i');
        $qb->where("i.invoiceModule = :invoice");
        $qb->setParameter('invoice', $invoice->getId());
        $sum = $qb->getQuery()->getSingleScalarResult();
        $invoice->setTotalAmount($sum);
        $invoice->setPaidAmount($sum);
        $this->_em->persist($invoice);
        $this->_em->flush();

    }

    public function insertAppModule($invoice)
    {
        $globalOption = $invoice->getGlobalOption();
        $modules = $globalOption->getSiteSetting()->getAppModules();
        if(!empty($modules)){
            foreach ($modules as $module){

                $item = New InvoiceModuleItem();
                $item->setInvoiceModule($invoice);
                $item->setName($module->getName());
                $item->setAppModule($module);
                $item->setAmount($module->getPrice());
                $this->_em->persist($item);

            }
            $this->_em->flush();
        }


    }
    public function insertModule($invoice)
    {
        $globalOption = $invoice->getGlobalOption();
        $modules = $globalOption->getSiteSetting()->getModules();
        if(!empty($modules)) {
            foreach ($modules as $module) {

                $item = New InvoiceModuleItem();
                $item->setInvoiceModule($invoice);
                $item->setModule($module);
                $item->setAmount($module->getPrice());
                $this->_em->persist($item);

            }
            $this->_em->flush();
        }
    }
    public function insertSyndicateModule($invoice)
    {
        $globalOption = $invoice->getGlobalOption();
        $modules = $globalOption->getSiteSetting()->getSyndicateModules();
        if(!empty($modules)) {
            foreach ($modules as $module) {

                $item = New InvoiceModuleItem();
                $item->setInvoiceModule($invoice);
                $item->setSyndicateModule($module);
                $item->setAmount($module->getPrice());
                $this->_em->persist($item);

            }
            $this->_em->flush();
        }
    }

    public function insertInvoiceModuleItem(InvoiceModule $invoiceModule, $data)
    {

        $em = $this->_em;
        if ($invoiceModule and isset($data['name']) and !empty($data['amount'])) {

            $i = 0;
            foreach ($data['name'] as $row):
                if (isset($data['name'][$i]) and !empty($data['amount'][$i])) {
                    if (!empty($data['name'][$i]) and !empty($data['amount'][$i]) and !empty($data['metaId'][$i])) {
                        $entity = $em->getRepository('SettingToolBundle:InvoiceModuleItem')->find($data['metaId'][$i]);
                    }else{
                        $entity = new InvoiceModuleItem();
                        $entity->setInvoiceModule($invoiceModule);
                    }
                    $entity->setName($data['name'][$i]);
                    $entity->setAmount($data['amount'][$i]);
                    $em->persist($entity);
                }
                $i++;
            endforeach;
            $em->flush();

        }

    }

}

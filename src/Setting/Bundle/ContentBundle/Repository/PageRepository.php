<?php

namespace Setting\Bundle\ContentBundle\Repository;

use Doctrine\ORM\EntityRepository;
use Setting\Bundle\AppearanceBundle\Entity\Menu;
use Setting\Bundle\ContentBundle\Entity\Page;
use Setting\Bundle\ToolBundle\Entity\GlobalOption;
use Setting\Bundle\ToolBundle\Entity\Module;

/**
 * PageRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class PageRepository extends EntityRepository
{

    public function getPagesFor($globalOption,$module = '')
    {

        $qb = $this->createQueryBuilder('e');
        $qb->where("e.globalOption = :globalOption");
        $qb->setParameter('globalOption', $globalOption->getId());
        if(!empty($module)) {
        $qb->join('e.module','module');
        $qb->andWhere("module.slug = :slug");
        $qb->setParameter('slug', $module);
        }
        $qb->orderBy('e.name', 'ASC');
        return $qb->getQuery()->getResult();
    }

    public function findModuleContentList(GlobalOption $doamin,$module)
    {

        $query = $this->createQueryBuilder('p')
            ->where('p.status = 1')
            ->andWhere('p.globalOption = :option')->setParameter('option', $doamin->getId())
            ->andWhere('p.module = :module')->setParameter('module', $module)
            ->orderBy('p.ordering','ASC')
            ->getQuery();
        return $query;
    }


    public  function insertPageMenu(Page $page)
    {

        $entity = new Menu();
        $em = $this->_em;
        if($page){

            $entity->setMenu($page->getMenu());
            $entity->setSlug($page->getSlug());
            $entity->setPage($page);
            $entity->setGlobalOption($page->getGlobalOption());

            $em->persist($entity);
            $em->flush();
        }

    }


    public  function updatePageMenu(Page $page)
    {

        $em = $this->_em;

            $entity = $em->getRepository('SettingAppearanceBundle:Menu')->findOneBy(array('page' => $page->getId()));
            if(!empty($entity)){

                $entity->setMenu($page->getMenu());
                $entity->setSlug($page->getSlug());
                $em->persist($entity);
                $em->flush();

            }else{

                $this->insertPageMenu($page);
            }


    }

    public function findFeatureContent($entity)
    {
        $user = $entity->getUser()->getId();
        $limit = $entity->getUser()->getHomePage()->getShowingListing();
        return $this->getEntityManager()
            ->createQuery('SELECT n FROM SettingContentBundle:Page n WHERE n.status = 1 AND n.user = '.$user.' ORDER BY n.name DESC')
            ->setMaxResults($limit)
            ->getResult();
    }

    public function findUserModuleContent($entity,$limit=5)
    {
        $user = $entity->getUser()->getId();
        $qb = $this->createQueryBuilder('a');
        $qb
            ->where($qb->expr()->eq('a.status', 1))
            ->andWhere($qb->expr()->eq('a.user', $user))
            ->setMaxResults($limit)
            ->orderBy('a.name', 'ASC');

        return $qb->getQuery()->getResult();
    }

    public function getCategoryPage($globalOption,$module,$cat){

        $em = $this->_em;

        $repository = $em->getRepository('SettingContentBundle:Page');
        $query = $repository->createQueryBuilder('p')
            ->innerJoin('p.moduleCategory', 'moduleCategory')
            ->where('p.globalOption = :option')
            ->setParameter('option', $globalOption->getId())
            ->andWhere('p.module = :module')
            ->setParameter('module', $module)
            ->andWhere('moduleCategory.id = :category')
            ->setParameter('category', $cat)
            ->getQuery();

        return $query;
    }

    public function findModuleContent($doamin,$module,$limit = 5)
    {

        $em = $this->_em;
        $repository = $em->getRepository('SettingContentBundle:Page');
        $query = $repository->createQueryBuilder('p')
            ->where('p.status = 1')
            ->andWhere('p.globalOption = :option')->setParameter('option', $doamin)
            ->andWhere('p.module = :module')->setParameter('module', $module)
            ->setMaxResults($limit)
            ->orderBy('p.ordering','ASC')
            ->getQuery()->getResult();
        return $query;
    }

    public function getListForModule($globalOption,$page)
    {

        $em = $this->_em;
        $modArr = array();
        foreach ($page->getPageModules() as $mod){
            $modArr[] = $mod->getModule()->getId();
        }
        $repository = $em->getRepository('SettingContentBundle:Page');
        $query = $repository->createQueryBuilder('p')
            ->where('p.globalOption = :option')
            ->setParameter('option', $globalOption->getId())
            ->andWhere('p.module IN  (:modules)')
            ->setParameter('modules',$modArr)
            ->orderBy('p.ordering','ASC')
            ->getQuery()->getResult();
            return $query;
    }

    public function getPages($globalOption)
    {

        $em = $this->_em;

        $query = $this->createQueryBuilder('p')
            ->select('p.id as id','p.menu as menu')
            ->where('p.status = 1')
            ->andWhere('p.globalOption = :option')
            ->setParameter('option', $globalOption->getId())
            ->orderBy('p.ordering','ASC')
            ->getQuery()->getArrayResult();
            return $query;
    }

    public function searchResult($globalOption,$keyword)
    {
        $qb = $this->createQueryBuilder('p')
            ->where('p.globalOption = :option')
            ->setParameter('option', $globalOption->getId())
            ->andWhere('p.name LIKE :searchTerm OR p.content LIKE :searchTerm')
            ->setParameter('searchTerm', '%'.$keyword.'%')
            ->orderBy('p.updated','DESC')
            ->getQuery();
        return $qb;
    }


}

<?php

namespace Setting\Bundle\AppearanceBundle\Entity;

use Doctrine\ORM\EntityRepository;
use Setting\Bundle\ContentBundle\Entity\ModuleCategory;
use Setting\Bundle\ContentBundle\Entity\Page;

/**
 * MenuRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class MenuRepository extends EntityRepository
{

    public function createMenuForPage(Page $reEntity = null)
    {
        $entity = new Menu();

        if ($reEntity != null) {

            $entity->setGlobalOption($reEntity->getGlobalOption());
            $entity->setMenu($reEntity->getMenu());
            $entity->setSlug($reEntity->getSlug());
            $entity->setPage($reEntity);
            $this->getEntityManager()->persist($entity);
            $this->getEntityManager()->flush();
        }
    }

    public function updateMenu($data)
    {

        $em = $this->getEntityManager();
        foreach ($data['id'] as $index => $id ){
            $menu = ($data['menu'][$index]) ? $data['menu'][$index] : null ;
            $slug = ($data['slug'][$index]) ? $data['slug'][$index] : '' ;
            $entity = $this->findOneBy(array('id'=>$id));
            if (!empty($entity)) {
                $entity->setMenu($menu);
                if($slug){
                    $entity->setSlug($slug);
                }
                $em->persist($entity);
            }
        }
        $em->flush();
    }


    public function createMenuForCategory(ModuleCategory $reEntity = null)
    {
        $entity = new Menu();

        if ($reEntity != null) {

            $slug = 'category/'.$reEntity->getModule()->getSlug().'/'.$reEntity->getSlug();
            $entity->setGlobalOption($reEntity->getGlobalOption());
            $entity->setCategory($reEntity);
            $entity->setMenu($reEntity->getName());
            $entity->setSlug($slug);
            $this->getEntityManager()->persist($entity);
            $this->getEntityManager()->flush();

        }
    }

    public function updateMenuForCategory(ModuleCategory $entity)
    {

        $em = $this->_em;

        $menu = $em->getRepository('SettingAppearanceBundle:Menu')->findOneBy(array('category' => $entity));
        if(!empty($menu)){
            $slug = 'category/'.$entity->getModule()->getSlug().'/'.$entity->getSlug();
            $menu->setMenu($entity->getName());
            $menu->setSlug($slug);
            $em->persist($menu);
            $em->flush();

        }else{
            $this->createMenuForCategory($entity);
        }
    }
}

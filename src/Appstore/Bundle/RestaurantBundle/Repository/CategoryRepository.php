<?php

namespace Appstore\Bundle\RestaurantBundle\Repository;

use Appstore\Bundle\RestaurantBundle\Entity\Category;
use Appstore\Bundle\RestaurantBundle\Entity\Invoice;
use Appstore\Bundle\RestaurantBundle\Entity\InvoiceParticular;
use Appstore\Bundle\RestaurantBundle\Entity\Particular;
use Appstore\Bundle\RestaurantBundle\Entity\Purchase;
use Appstore\Bundle\RestaurantBundle\Entity\PurchaseItem;
use Appstore\Bundle\RestaurantBundle\Entity\RestaurantConfig;
use Doctrine\ORM\EntityRepository;
use Setting\Bundle\ToolBundle\Entity\GlobalOption;


/**
 * ParticularRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class CategoryRepository extends EntityRepository
{

    public function setCategorySorting($data)
    {
        $i = 1;
        $em = $this->_em;
        foreach ($data as $key => $value){
            $particular = $this->findOneBy(array('status'=> 1,'id' => $value));
            $particular->setSorting($i);
            $em->persist($particular);
            $em->flush();
            $i++;
        }
    }

    public function getCategories(RestaurantConfig  $config)
    {
        $config = $config->getId();
        $qb = $this->createQueryBuilder('s');
        $qb->join('s.service','c');
        $qb->where('s.restaurantConfig = :config')->setParameter('config', $config);
        $qb->andWhere('c.slug IN (:slugs)')->setParameter('slugs',array('product','stockable'));
        $qb->andWhere('e.status = :status')->setParameter('status',1) ;
        $qb->orderBy('e.name','ASC');
        $result = $qb->getQuery()->getResult();
        return  $result;
    }

    public function getApiCategory(GlobalOption $option)
    {

        $config = $option->getRestaurantConfig()->getId();
        $qb = $this->createQueryBuilder('e');
        $qb->select('e.id','e.name','e.slug');
        $qb->leftJoin('e.service','c');
        $qb->where('e.restaurantConfig = :config')->setParameter('config', $config) ;
        $qb->andWhere('e.status = :status')->setParameter('status',1) ;
        $qb->andWhere('c.slug IN (:slugs)')->setParameter('slugs',array('product','stockable'));
        $qb->orderBy('e.sorting','ASC');
        $result = $qb->getQuery()->getArrayResult();

        $data = array();

        /* @var $row Category */

        foreach($result as $key => $row) {

            $data[$key]['global_id']        = (int) $option->getId();
            $data[$key]['category_id']      = (int) $row['id'];
            $data[$key]['name']             = $row['name'];
            $data[$key]['slug']             = $row['slug'];

        }

        return $data;
    }

}

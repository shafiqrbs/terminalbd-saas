<?php

namespace Appstore\Bundle\InventoryBundle\Repository;
use Appstore\Bundle\InventoryBundle\Entity\PurchaseReturnItem;
use Doctrine\ORM\EntityRepository;

/**
 * PurchaseReturnItemRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class PurchaseReturnItemRepository extends EntityRepository
{

    public function insertPurchaseReturnsItems($purchaseReturn,$purchaseItem)
    {
        $em = $this->_em;
        $existEntity = $this->findOneBy(array('purchaseReturn'=> $purchaseReturn,'purchaseItem'=> $purchaseItem));
        if(!empty($existEntity)){

            $qnt = ($existEntity->getQuantity()+1);
            $existEntity->setQuantity($qnt);
            $existEntity->setSubTotal($existEntity->getPrice() * $qnt);
            $em->persist($existEntity);

        }else{

            $entity = new PurchaseReturnItem();
            $entity->setPurchaseReturn($purchaseReturn);
            $entity->setPurchaseItem($purchaseItem);
            $entity->setPrice($purchaseItem->getPurchasePrice());
            $entity->setQuantity(1);
            $entity->setSubTotal($purchaseItem->getPurchasePrice());
            $em->persist($entity);
        }
        $em->flush();
    }

    public function getPurchaseReturnItems($purchaseReturn)
    {
        $entities = $purchaseReturn->getPurchaseReturnItems();
        $data = '';
        $i = 1;
        foreach( $entities as $entity){

            $data .='<tr id="subItem-'.$entity->getId().'">';
            $data .='<td class="numeric" >'.$i.'</td>';
            $data .='<td class="numeric" >'.$entity->getPurchaseItem()->getPurchaseVendorItem()->getName().'</td>';
            $data .='<td class="numeric" >'.$entity->getPurchaseItem()->getBarcode().'</td>';
            $data .='<td class="numeric" ><input type="text" name="quantity[]"  id="quantity-'.$entity->getId().'" class="m-wrap span10 quantity" rel="'.$entity->getId().'" value="'.$entity->getQuantity().'" placeholder="'.$entity->getQuantity().'"></td>';
            $data .='<td class="numeric" ><input class="m-wrap span8 numeric price"  rel="'.$entity->getId().'" id="price-'.$entity->getId().'" type="text" name="price" value="'.$entity->getPrice().'" placeholder="'.$entity->getPrice().'"></td>';
            $data .='<td class="numeric" ><span id="subTotalShow-'. $entity->getId().'" >'.$entity->getSubTotal().'</span></td>';
            $data .='<td class="numeric" ><a id="'.$entity->getId().'" title="Are you sure went to delete ?" rel="/inventory/purchasereturn/'.$purchaseReturn->getId().'/'.$entity->getId().'/delete" href="javascript:" class="btn red mini delete" ><i class="icon-trash"></i></a></td>';
            $data .='</tr>';
            $i++;
        }
        return $data;
    }
}

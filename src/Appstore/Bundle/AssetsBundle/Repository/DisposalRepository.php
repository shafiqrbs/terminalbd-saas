<?php

namespace Appstore\Bundle\AssetsBundle\Repository;
use Appstore\Bundle\AssetsBundle\Entity\Disposal;
use \Doctrine\ORM\EntityRepository;

/**
 * ParticularRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class DisposalRepository extends EntityRepository
{
	public  function disposalUpdate(Disposal $purchase){

		$qb = $this->createQueryBuilder('p');
		$qb->join('p.disposalItems', 'pvi');
		$qb->select('p.id as id');
		$qb->addSelect('SUM(pvi.quantity) AS quantity ');
		$qb->addSelect('COUNT(pvi.id) AS item ');
		$qb->addSelect('SUM(pvi.salesPrice) AS total');
		$qb->where("p.id = :purchaseId");
		$qb->setParameter('purchaseId', $purchase);
		$row = $qb->getQuery()->getOneOrNullResult();

		$purchase->setTotalQuantity($row['quantity']);
		$purchase->setTotalItem($row['quantity']);
		$purchase->setSubTotal($row['total']);
		$this->_em->persist($purchase);
		$this->_em->flush($purchase);

	}

}

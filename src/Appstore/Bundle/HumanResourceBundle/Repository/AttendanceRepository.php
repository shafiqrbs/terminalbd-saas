<?php

namespace Appstore\Bundle\HumanResourceBundle\Repository;
use Appstore\Bundle\DomainUserBundle\Entity\CustomerInbox;
use Appstore\Bundle\HumanResourceBundle\Entity\Attendance;
use Appstore\Bundle\HumanResourceBundle\Entity\EmployeeLeave;
use Core\UserBundle\Entity\User;
use Doctrine\ORM\EntityRepository;
use Setting\Bundle\ToolBundle\Entity\GlobalOption;

/**
 * AttendanceMonthRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class AttendanceRepository extends EntityRepository
{

    public function setupMonthlyAttendance(GlobalOption $globalOption, $employees,$weekend)
    {

        $datetime       = new \DateTime("now");
        $month          = (string)$datetime->format('F');
        $monthNumber    = (string)$datetime->format('m');
        $year           = (string)$datetime->format('Y');

        $dates =array();
        for($i = 1; $i <=  date('t'); $i++)
        {
            $dates[] = date('m') . "/" . str_pad($i, 2, '0', STR_PAD_LEFT) . "/" .date('Y');
        }
        $totalNumberOfDays = cal_days_in_month(CAL_GREGORIAN, $monthNumber, $year);
        $monthWeekend = count(array_intersect($weekend, $dates));

        /* @var $employee User */

        foreach ($employees as $employee) {

            $attendance = $this->findOneBy(array('globalOption' => $globalOption, 'employee' => $employee['id'], 'year' => $year, 'month' => $month));
           if(empty($attendance)){
                $entity = new Attendance();
                $entity->setYear($year);
                $entity->setMonth($month);
                $entity->setGlobalOption($globalOption);
                $entity->setEmployee($this->_em->getRepository('UserBundle:User')->find($employee['id']));
                $entity->setTotalDay($totalNumberOfDays);
                $entity->setWeekend($monthWeekend);
                $this->_em->persist($entity);
                $this->_em->flush();
            }
        }
    }

    public function leaveAttendance(EmployeeLeave $leave,$weekend)
    {

      //   $noOfDay = 4;
         for ($i = 1; $i <= $leave->getNoOffDay(); $i++) {
            $datetime = $leave->getStartDate();
            if($i != 1){
                $datetime->modify('+' . 1 . ' day');
            }
            $attendance = $this->findLeaveMonth($leave,$datetime,$weekend);
            $this->_em->getRepository('HumanResourceBundle:DailyAttendance')->dailyLeaveAttendance($leave,$attendance,$datetime);
         }
    }

    public function findLeaveMonth(EmployeeLeave $leave,\DateTime $datetime,$weekend){

        $monthEndDay = $datetime->format('t');
        $month = $datetime->format('F');
        $year = $datetime->format('Y');

        $dates =array();
        for($i = 1; $i <=  date($monthEndDay); $i++)
        {
            $dates[] = date('m') . "/" . str_pad($i, 2, '0', STR_PAD_LEFT) . "/" .date('Y');
        }
        $monthWeekend = count(array_intersect($weekend, $dates));
        $attendance = $this->findOneBy(array('globalOption' => $leave->getGlobalOption(), 'employee' => $leave->getEmployee(), 'month' => $month, 'year' => $year));
        if(empty($attendance)){
            $attendance = new Attendance();
            $attendance->setYear($year);
            $attendance->setMonth($month);
            $attendance->setGlobalOption($leave->getGlobalOption());
            $attendance->setEmployee($leave->getEmployee());
            $attendance->setTotalDay($monthEndDay);
            $attendance->setWeekend($monthWeekend);
            $this->_em->persist($attendance);
            $this->_em->flush();
        }
        return $attendance;
    }

    public function currentMonthEmployeeAttendance(GlobalOption $option)
    {
        $datetime = new \DateTime("now");
        $month  = $datetime->format('F');
        $year   = $datetime->format('Y');

        $qb = $this->createQueryBuilder('e');
        $qb->where('e.globalOption='.$option->getId());
        $qb->andWhere('e.year = :year')->setParameter('year',$year);
        $qb->andWhere('e.month = :month')->setParameter('month',$month);
        $qb->orderBy('e.month','ASC');
        $result = $qb->getQuery()->getResult();
        return $result;

    }

    public function monthWiseAttendance(User $user)
    {

        $qb = $this->createQueryBuilder('e');
        $qb->andWhere('e.employee = :employee')->setParameter('employee',$user);
        $qb->orderBy('e.year','DESC');
        $qb->orderBy('e.month','ASC');
        $result = $qb->getQuery()->getResult();
        return $result;

    }

    public function employeeTotalPresentDay(Attendance $attendance)
    {
        $qb = $this->_em->createQueryBuilder();
        $qb->from('HumanResourceBundle:DailyAttendance','e');
        $qb->select('sum(e.present) AS present');
        $qb->where('e.attendance = :attendance')->setParameter('attendance', $attendance->getId());
        $qb->andWhere('e.present = :present')->setParameter('present', 1);
        $result = $qb->getQuery()->getOneOrNullResult();
        $presentDay =  $result['present'];
        $attendance->setPresent($presentDay);
        $this->_em->persist($attendance);
        $this->_em->flush();
    }

    public function monthlyEmployeeAttendance(GlobalOption $option , $data = array())
    {
        if(empty($data)){
            $datetime   = new \DateTime("now");
            $month      = $datetime->format('F');
            $year       = $datetime->format('Y');
        }else{
            $month      = $data['month'];
            $year       = $data['year'];
        }
        $qb = $this->createQueryBuilder('e');
        $qb->join('e.employee','u');
        $qb->select('e.present as present','e.absence as absence','e.totalDay','e.weekend');
        $qb->addSelect('u.id as userId');
        $qb->where('e.globalOption='.$option->getId());
        $qb->andWhere('e.year = :year')->setParameter('year',$year);
        $qb->andWhere('e.month = :month')->setParameter('month',$month);
        $qb->orderBy('e.month','ASC');
        $result = $qb->getQuery()->getArrayResult();
        return $result;

    }


}

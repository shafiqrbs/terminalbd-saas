<?php

namespace Appstore\Bundle\MedicineBundle\Repository;
use Appstore\Bundle\MedicineBundle\Entity\MedicineConfig;
use Appstore\Bundle\MedicineBundle\Entity\MedicinePurchaseItem;
use Appstore\Bundle\MedicineBundle\Entity\MedicinePurchaseReturn;
use Appstore\Bundle\MedicineBundle\Entity\MedicineStock;
use Appstore\Bundle\MedicineBundle\Entity\MedicineVendor;
use Doctrine\ORM\EntityRepository;


/**
 * HmsVendorRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class MedicinePurchaseReturnRepository extends EntityRepository
{

    public function updatePurchaseReturnTotalPrice(MedicinePurchaseReturn $entity)
    {
        $em = $this->_em;
        $total = $em->createQueryBuilder()
            ->from('MedicineBundle:MedicinePurchaseReturnItem','si')
            ->select('sum(si.subTotal) as total')
            ->where('si.medicinePurchaseReturn = :entity')
            ->setParameter('entity', $entity ->getId())
            ->getQuery()->getSingleResult();

        if($total['total'] > 0){
            $entity->setSubTotal(round($total['total']));
            $entity->setTotal(round($total['total']));
        }else{
            $entity->setSubTotal(0);
            $entity->setTotal(0);
        }

        $em->persist($entity);
        $em->flush();
        return $entity;

    }

    public function updatePurchaseAdjustment(MedicinePurchaseReturn $purchase_return)
    {
	    $purchase_return->setAdjusted(true);
	    $this->_em->persist($purchase_return);
	    $this->_em->flush($purchase_return);
    }

	public function removePurchaseAdjustment(MedicinePurchaseReturn $purchase_return)
	{
		$purchase_return->setAdjusted(NULL);
		$this->_em->persist($purchase_return);
		$this->_em->flush($purchase_return);
	}
}

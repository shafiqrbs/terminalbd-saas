<?php

namespace Appstore\Bundle\HotelBundle\Repository;
use Appstore\Bundle\AccountingBundle\Entity\AccountSales;
use Appstore\Bundle\HotelBundle\Entity\HotelInvoice;
use Appstore\Bundle\HotelBundle\Entity\HotelInvoiceTransaction;
use Core\UserBundle\Entity\User;
use Doctrine\ORM\EntityRepository;


/**
 * HotelHotelInvoiceTransactionRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class HotelInvoiceTransactionRepository extends EntityRepository
{

    public function todaySalesOverview(User $user , $data , $previous ='', $mode='')
    {

        if (empty($data)) {
            $datetime = new \DateTime("now");
            $data['startDate'] = $datetime->format('Y-m-d 00:00:00');
            $data['endDate'] = $datetime->format('Y-m-d 23:59:59');
        } elseif (!empty($data['startDate']) and !empty($data['endDate'])) {
            $data['startDate'] = date('Y-m-d', strtotime($data['startDate']));
            $data['endDate'] = date('Y-m-d', strtotime($data['endDate']));
        }

        $hospital = $user->getGlobalOption()->getHotelConfig()->getId();
        $qb = $this->createQueryBuilder('it');
        $qb->join('it.businessInvoice', 'e');
        $qb->select('sum(it.total) as total ,sum(it.discount) as discount , sum(it.payment) as payment');
        $qb->where('e.hospitalConfig = :hospital')->setParameter('hospital', $hospital);
        if ($previous == 'true'){

            if (!empty($data['startDate'])) {
                $qb->andWhere("it.updated >= :startDate");
                $qb->setParameter('startDate', $data['startDate'] . ' 00:00:00');
            }
            if (!empty($data['endDate'])) {
                $qb->andWhere("it.updated <= :endDate");
                $qb->setParameter('endDate', $data['endDate'] . ' 23:59:59');
            }
            if (!empty($data['startDate'])) {
                $qb->andWhere("e.created >= :startDate");
                $qb->setParameter('startDate', $data['startDate'] . ' 00:00:00');
            }
            if (!empty($data['endDate'])) {
                $qb->andWhere("e.created <= :endDate");
                $qb->setParameter('endDate', $data['endDate'] . ' 23:59:59');
            }

        }elseif ($previous == 'false'){

            if (!empty($data['startDate'])) {
                $qb->andWhere("e.created < :startDate");
                $qb->setParameter('startDate', $data['startDate'] . ' 00:00:00');
            }
            if (!empty($data['startDate'])) {
                $qb->andWhere("it.updated >= :startDate");
                $qb->setParameter('startDate', $data['startDate'] . ' 00:00:00');
            }
            if (!empty($data['endDate'])) {
                $qb->andWhere("it.updated <= :endDate");
                $qb->setParameter('endDate', $data['endDate'] . ' 23:59:59');
            }

        }
        if (!empty($mode)){
            $qb->andWhere('e.invoiceMode = :mode')->setParameter('mode', $mode);
        }
        $qb->andWhere('it.process = :process')->setParameter('process', 'Done');
        $result = $qb->getQuery()->getOneOrNullResult();
        $total = !empty($result['total']) ? $result['total'] :0;
        $discount = !empty($result['discount']) ? $result['discount'] :0;
        $receive = !empty($result['payment']) ? $result['payment'] :0;
        $data = array('total'=> $total ,'discount'=> $discount ,'receive'=> $receive);
        return $data;
    }

    public function handleDateRangeFind($qb,$data)
    {
        if(empty($data)){
            $datetime = new \DateTime("now");
            $data['startDate'] = $datetime->format('Y-m-d 00:00:00');
            $data['endDate'] = $datetime->format('Y-m-d 23:59:59');
        }else{
            $data['startDate'] = date('Y-m-d',strtotime($data['startDate']));
            $data['endDate'] = date('Y-m-d',strtotime($data['endDate']));
        }

        if (!empty($data['startDate']) ) {
            $qb->andWhere("ip.updated >= :startDate");
            $qb->setParameter('startDate', $data['startDate'].' 00:00:00');
        }
        if (!empty($data['endDate'])) {
            $qb->andWhere("ip.updated <= :endDate");
            $qb->setParameter('endDate', $data['endDate'].' 23:59:59');
        }
    }


    public function findWithTransactionOverview(User $user, $data)
    {
        $hospital = $user->getGlobalOption()->getHotelConfig()->getId();
        $qb = $this->createQueryBuilder('ip');
        $qb->join('ip.businessInvoice','e');
        $qb->leftJoin('ip.transactionMethod','p');
        $qb->select('sum(ip.payment) as paymentTotal');
        $qb->addSelect('p.name as transName');
        $qb->where('e.hospitalConfig = :hospital')->setParameter('hospital', $hospital);
        if (!empty($mode)){
            $qb->andWhere('e.invoiceMode = :mode')->setParameter('mode', $mode);
        }
        $qb->andWhere("e.process IN (:process)");
        $qb->setParameter('process', array('Done','Paid','In-progress','Diagnostic','Admitted'));
        $this->handleDateRangeFind($qb,$data);
        $qb->groupBy('p.id');
        $result = $qb->getQuery()->getArrayResult();
        return $result;
    }



    public function initialInsertHotelInvoiceTransaction(HotelInvoice $invoice){

        $code = $this->getLastCode($invoice);
        $entity = New HotelInvoiceTransaction();
        $entity->setHotelInvoice($invoice);
        $entity->setCode($code + 1);
        $transactionCode = sprintf("%s", str_pad($entity->getCode(),2, '0', STR_PAD_LEFT));
        $entity->setProcess('Done');
        $entity->setTransactionCode($transactionCode);
        $entity->setDiscount($invoice->getDiscount());
        $entity->setTotal($invoice->getTotal());
        $entity->setReceived($invoice->getPayment());
        $entity->setDue($invoice->getDue());
        $this->_em->persist($entity);
        $this->_em->flush($entity);
        return $entity;

    }

    public function insertTransaction(HotelInvoice $invoice)
    {
        $entity = New HotelInvoiceTransaction();
        $code = $this->getLastCode($invoice);
        $entity->setHotelInvoice($invoice);
        $entity->setCode($code + 1);
        $transactionCode = sprintf("%s", str_pad($entity->getCode(),2, '0', STR_PAD_LEFT));
        $entity->setTransactionCode($transactionCode);
        $entity->setProcess('Done');
        $entity->setPayment($invoice->getPayment());
        $entity->setTransactionMethod($invoice->getTransactionMethod());
        $entity->setAccountBank($invoice->getAccountBank());
        $entity->setPaymentCard($invoice->getPaymentCard());
        $entity->setCardNo($invoice->getCardNo());
        $entity->setBank($invoice->getBank());
        $entity->setAccountMobileBank($invoice->getAccountMobileBank());
        $entity->setPaymentMobile($invoice->getPaymentMobile());
        $entity->setTransactionId($invoice->getTransactionId());
        $entity->setComment($invoice->getComment());
        $this->_em->persist($entity);
        $this->_em->flush($entity);
        if($invoice->getPayment() > 0){
            $accountHotelInvoice = $this->_em->getRepository('AccountingBundle:AccountSales')->insertAccountHotelInvoice($entity);
            $this->_em->getRepository('AccountingBundle:Transaction')->hmsSalesTransaction($entity, $accountHotelInvoice);
        }

    }


    public function insertPaymentTransaction(HotelInvoice $invoice)
    {
        $entity = New HotelInvoiceTransaction();
        $code = $this->getLastCode($invoice);
        $entity->setHotelInvoice($invoice);
        $entity->setCode($code + 1);
        $transactionCode = sprintf("%s", str_pad($entity->getCode(),2, '0', STR_PAD_LEFT));
        $entity->setTransactionCode($transactionCode);
        $entity->setProcess('In-progress');
        $entity->setPayment($invoice->getTransactionMethod());
        $entity->setTransactionMethod($invoice->getTransactionMethod());
        $entity->setAccountBank($invoice->getAccountBank());
        $entity->setPaymentCard($invoice->getPaymentCard());
        $entity->setCardNo($invoice->getCardNo());
        $entity->setBank($invoice->getBank());
        $entity->setAccountMobileBank($invoice->getAccountMobileBank());
        $entity->setPaymentMobile($invoice->getPaymentMobile());
        $entity->setTransactionId($invoice->getTransactionId());
        $entity->setComment($invoice->getComment());
        $this->_em->persist($entity);
        $this->_em->flush($entity);

    }

	public function hmsSalesTransactionReverse(HotelInvoice $entity)
    {


        $em = $this->_em;

        if(!empty($entity->getAccountSales())){
            /* @var AccountSales $sales*/
            foreach ($entity->getAccountSales() as $sales ){

                $globalOption = $sales->getGlobalOption()->getId();
                $accountRefNo = $sales->getAccountRefNo();
                $transaction = $em->createQuery("DELETE AccountingBundle:Transaction e WHERE e.globalOption = ".$globalOption ." AND e.accountRefNo =".$accountRefNo." AND e.processHead = 'Sales'");
                $transaction->execute();
                $accountCash = $em->createQuery("DELETE AccountingBundle:AccountCash e WHERE e.globalOption = ".$globalOption ." AND e.accountRefNo =".$accountRefNo." AND e.processHead = 'Sales'");
                $accountCash->execute();
            }
        }

        $accountCash = $em->createQuery('DELETE AccountingBundle:AccountSales e WHERE e.businessHotelInvoices = '.$entity->getId());
        if(!empty($accountCash)){
            $accountCash->execute();
        }

        $transaction = $em->createQuery('DELETE HotelBundle:HotelInvoiceTransaction e WHERE e.businessHotelInvoice = '.$entity->getId());
        if(!empty($transaction)) {
            $transaction->execute();
        }
    }

    public function hmsAdmissionSalesTransactionReverse(HotelInvoice $entity)
    {

        $em = $this->_em;

        if(!empty($entity->getAccountSales())){
            /* @var AccountSales $sales*/
            foreach ($entity->getAccountSales() as $sales ){

                $globalOption = $sales->getGlobalOption()->getId();
                $accountRefNo = $sales->getAccountRefNo();
                $transaction = $em->createQuery("DELETE AccountingBundle:Transaction e WHERE e.globalOption = ".$globalOption ." AND e.accountRefNo =".$accountRefNo." AND e.processHead = 'Sales'");
                $transaction->execute();
                $accountCash = $em->createQuery("DELETE AccountingBundle:AccountCash e WHERE e.globalOption = ".$globalOption ." AND e.accountRefNo =".$accountRefNo." AND e.processHead = 'Sales'");
                $accountCash->execute();
            }
        }

        $accountCash = $em->createQuery('DELETE AccountingBundle:AccountSales e WHERE e.businessHotelInvoices = '.$entity->getId());
        if(!empty($accountCash)){
            $accountCash->execute();
        }

        $qb = $this->createQueryBuilder('it');
        $q = $qb->update()
            ->set('it.process', $qb->expr()->literal('In-progress'))
            ->set('it.revised', $qb->expr()->literal(1))
            ->where('it.businessHotelInvoice = :invoice')
            ->setParameter('invoice', $entity->getId())
            ->getQuery();
        $q->execute();
    }

    public function updateHotelInvoiceTransactionDiscount(HotelInvoice $entity)
    {

        /** @var HotelInvoiceTransaction $transaction */
        foreach ($entity->getHotelInvoiceTransactions() as $transaction) {

            $transaction->setDiscount(0);
            $this->_em->persist($transaction);
            $this->_em->flush($transaction);
        }
        foreach ($entity->getHotelInvoiceTransactions() as $transaction) {

            if( empty($transaction->getPayment()) and empty($transaction->getDiscount())){

                $qb = $this->_em->createQueryBuilder();
                $qb->delete('HotelBundle:HotelInvoiceTransaction', 'trans')
                    ->where($qb->expr()->eq('trans.id', ':id'))
                    ->setParameter('id', $transaction->getId());
                $qb->getQuery()->execute();
            }
        }
    }

    public function removePendingTransaction(HotelInvoice $entity)
    {
        $em = $this->_em;
        $qb = $em->createQueryBuilder();
        $query = $qb->delete('HotelBundle:HotelInvoiceTransaction', 'e')
            ->where('e.hotelInvoice = :businessHotelInvoice')
            ->setParameter('businessHotelInvoice', $entity->getId())
            ->andWhere('e.process IN (:process)')
            ->setParameter('process',array('Pending','In-progress'))
            ->getQuery();
        if(!empty($query)) {
            $query->execute();
        }
    }

    public function getCulculationVat(HotelInvoice $invoice, $totalAmount)
    {
        $vat = (($totalAmount * (int)$invoice->getHotelConfig()->getVatPercentage()) / 100);
        return round($vat);
    }

    public function getHotelInvoiceTransactionLists(HotelInvoice $invoice){

	    $qb = $this->createQueryBuilder('hi');
	   // $qb->join('hi.hotelInvoice','e');
	   // $qb->where('e.hotelConfig = :config')->setParameter('config', $invoice->getHotelConfig()->getId());
	    $qb->where('hi.referenceInvoice = :reference')->setParameter('reference', $invoice->getId());
	    $qb->orderBy('hi.updated','DESC');
	    $result = $qb->getQuery()->getResult();
	    return $result;

    }

    public function getHotelInvoiceTransactionItems(HotelInvoice $invoice)
    {
        $entities = $this->getHotelInvoiceTransactionLists($invoice);
        $data = '';
        $i = 1;

        /** @var HotelInvoiceTransaction $transaction */

        foreach ($entities as $transaction) {

            $date = $transaction->getUpdated()->format('d-m-Y');
            $transactionMethod ='';
            if(!empty($transaction->getTransactionMethod())){
                $transactionMethod = $transaction->getTransactionMethod()->getName();
            }
            $data .= "<tr id='delete-{$transaction->getId()}'>";
            $data .= "<td class='numeric' >{$i}</td>";
            $data .= "<td class='numeric' >{$date}</td>";
            $data .= "<td class='numeric' >{$transaction->getHotelInvoice()->getInvoice()}/{$transaction->getHotelInvoice()->getInvoiceFor()}</td>";
	        $data .= "<td class='numeric' >{$transaction->getSubTotal()}</td>";
	        $data .= "<td class='numeric' >{$transaction->getDiscount()}</td>";
	        $data .= "<td class='numeric' >{$transaction->getTotal()}</td>";
	        $data .= "<td class='numeric' >{$transaction->getVat()}</td>";
	        $data .= "<td class='numeric' >{$transaction->getServiceCharge()}</td>";
	        $data .= "<td class='numeric' >{$transaction->getReceived()}</td>";
	        $data .= "<td class='numeric' >{$transaction->getDue()}</td>";
	        $data .= "<td> <span id='approved-{$transaction->getId()}'>";
			$arrs = array('created','pending','in-progress');
	        if(in_array($transaction->getProcess(),$arrs)){
		        $data .= "<a id='{$transaction->getId()}' data-id='{$transaction->getId()}' data-url='/hotel-restaurant/invoice/{$transaction->getId()}/payment-delete' href='javascript:' class='btn red mini delete' ><i class='icon-trash'></i></a>";
		        $data .= "<a id='{$transaction->getId()}' data-id='{$transaction->getId()}' data-url='/hotel-restaurant/invoice/{$transaction->getId()}/payment-approved' href='javascript:' class='btn blue mini approve' ><i class='icon-ok'></i> Approve</a>";
	        }else{
		        $data .= "<a id='{$transaction->getId()}' data-id='{$transaction->getId()}' target='_blank'  href='/hotel-restaurant/invoice/{$transaction->getId()}/payment-print' class='btn purple mini' ><i class='icon-print'></i> Print</a>";
	        }
	        $data .= "</span></td>";
	        $i++;
        }
        return $data;
    }

    public function getLastCode(HotelInvoice $invoice)
    {
        $qb = $this->_em->getRepository('HotelBundle:HotelInvoiceTransaction')->createQueryBuilder('s');
        $qb
            ->select('MAX(s.code)')
            ->where('s.hotelInvoice = :invoice')
            ->setParameter('invoice', $invoice->getId());
            $lastCode = $qb->getQuery()->getSingleScalarResult();
        if (empty($lastCode)) {
            return 0;
        }
        return $lastCode;
    }
}